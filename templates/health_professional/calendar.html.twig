{% extends 'base.html.twig' %}

{% block title %}
    Page de calendrier
{% endblock %}

{% block javascripts %}
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script type="module">
        import {calendar} from "/js/calendarConfig.js";
        import { addEventSource } from "/js/calendarConfig.js";
        document.addEventListener('DOMContentLoaded', function () {

            addEventSource([
                {% if appointments is not null %}
                    {% for consultation in appointments %}
                    {
                        id: '{{ consultation.id }}',
                        title: 'PATIENT : {{ consultation.patient.lastname|upper }} {{ consultation.patient.firstname
                        }} | TYPE : {{ consultation.consultationtype.label }} | SALLE : {{ consultation.room.num
                        }} | ÉTAGE : {{ consultation.room.floor }} | TYPE DE SALLE : {{ consultation.room.roomtype.label }}',
                        start: '{{ consultation.date|date('Y-m-d') }}T{{ consultation.startTime|date('H:i:s') }}',
                        end: '{{ consultation.date|date('Y-m-d') }}T{{ consultation.endTime|date('H:i:s') }}',
                        button: 'modifier'
                    },
                    {% endfor %}
                {% endif %}
            ]);
            calendar.render();
            calendar.on('eventClick', function(info) {
                const consultationDetails = `
            ${info.event.title}<br>
            <strong>Date :</strong> ${info.event.start.toLocaleString()}
        `;

                Swal.fire({
                    title: 'Détail de la consultation',
                    html: consultationDetails,
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonText: 'OK',
                    cancelButtonText: 'Modifier',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isDismissed) {
                        window.location.href = '{{ path('update_medical_appointment', {'id': 'consultation_id'}) }}'.replace('consultation_id', info.event.id);
                    }
                });
                document.getElementById('delete-btn')?.addEventListener('click', function() {
                    Swal.fire({
                        title: 'Êtes-vous sûr de vouloir supprimer ce rendez-vous ?',
                        text: 'Cette action est irréversible.',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Oui, supprimer',
                        cancelButtonText: 'Annuler'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Utilisation de l'ID dans l'URL de suppression
                            window.location.href = '{{ path('delete_medical_appointment', {'id': info.event.id}) }}';
                        }
                    });
                })
            });
        });
    </script>
{% endblock %}

{% block body %}
    <div id='calendar'></div>
{% endblock %}
